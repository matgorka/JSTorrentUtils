(t=>{let r=["xt","dn","xl","kt","so","tr","xs","as","ws","x.pe"],e=t=>/^urn:([A-Z\d]+(?::+[A-Z\d]+)*:*):(.*)/i.exec(t).slice(1),s=(t,r)=>{let e,s,i,n,a=7,o;if(r&&(t="http://"+t),[e,s]=/^(\w+:\/*)(.*)/.exec(t).slice(1),i=new URL("http://"+s),n=new URL("https://"+s),!i.port&&n.port&&(i=n,a=8),["udp://","tcp://"].includes(e)&&""===i.port)throw Error();return r&&(e=""),o=e+i.href.slice(a),t.endsWith("/")||(o=o.replace(/\/$/,"")),[o,e]},i=t=>{let r,e,i,n,a,o,f,c,l;try{[t,r]=s(t,!0),f=/(.*):\d+$/.exec(t)[1]}catch(p){return}if(/^\d+(\.\d+){3}$/.test(f)){for(c of f.split("."))if(c>255)return;return t}try{if(n=/^\[([\dA-F:]+)\]$/i.exec(f)[1],[e,i,o]=n.split("::"),o||/:::/.test(n)||(a=e.split(":"),void 0!==i&&(i=i.split(":"),a=a.concat(Array(8-a.length-i.length).fill(0),i)),a.length<8))return;for(l in a)if(""==a[l]&&(a[l]=0),a[l].length>4)return}catch(u){if(!/^[A-Z\d]([A-Z\d-]*[A-Z\d])?(\.[A-Z\d]([A-Z\d-]*[A-Z\d])?)*$/i.test(f)||!/[A-Z-]/i.test(f.split(".").pop()))return}return t},n=(t,r,e,s)=>{let i,n,a,o;for(i of(s.splice(0,s.length),t.split(",")))if(i&&/^\d+(-\d+)?$/.test(i))for((n=1*(i=i.split("-"))[0])>(a=i[1]||i[0])&&([a,n]=[n,a]),o=n;o<=Math.min(a,1e6);++o)r[o]=e;for(n=-1,a=0;a<=r.length;++a)r[a]?n<0&&(n=a):n>=0&&(a-n>1&&(n+="-"+(a-1)),s.push(n),n=-1)},a=(t,r)=>{let e=[],s=[];return n(t+","+r,e,1,s),r=s.join(),n(t,e,0,s),[r,s.join()]},o=(t,r,n,o)=>{let f=r=>{let e,s;for(e of(void 0!==r&&(d=[r]),d))for(s of t._validators)if(!s(n,e))return 0;return void 0!==r&&(d=[]),1},c=[],l,p,u=[],h,d=[],g,m,y,x;try{n=n.toLowerCase(),"object"==typeof o&&(o=o.valueOf())}catch($){return}if(["number","string"].includes(typeof o)&&""!==o){switch("kt"!=n&&(o=decodeURIComponent(o)),n){case"xl":if(parseInt(o)!=o||o<0)return;case"dn":d.push(o),delete r[n];break;case"kt":return r.kt||(r.kt=[""]),o=o.toLowerCase(),u=r.kt[0]+"+"+o,u=[...new Set(u.split(/[\+\s]+/))].filter(t=>""!==t).filter(t=>!r.kt[0].split("+").includes(t)).filter(t=>f(t)),o=r.kt[0].split("+").concat(u).join("+").replace(/^\+/,""),r.kt=[o],o;case"so":if(r.so||(r.so=[""]),[o,h]=a(r.so[0],o),h.length&&!f(h))return;return r.so=[o],o;case"xt":try{c=r.xt.map(t=>e(t)[0])}catch(w){}try{[l,p]=e(o)}catch(k){return}if(!f([l,p]))return;if((x=c.indexOf(l))>=0)return r.xt[x]=o,o;break;case"x.pe":o=i(o),d.push(o);break;case"tr":case"ws":case"as":case"xs":try{[o,l]=s(o)}catch(A){return}d.push(l);break;default:try{g=r[n][0]}catch(v){}try{for(m of t._parsers)if(y=m(n,o,d,g))break;if(y){if("string"!=typeof y)throw TypeError("Custom parser error: string was expected");o=y}else if(!t.isAllowingUnknownParams)return}catch(_){return}}if(o&&f())return r[n]?(r[n].includes(o)||r[n].push(o),o):(r[n]=[o],o)}},f=(t,r,e,s)=>{if(r){if("string"==typeof r){if("string"!=typeof e){if(Array.isArray(e)){for(e of e)f(t,r,e,s);return}if(!e){for([r,e]of r=r.split("&").map(t=>t.split("="))){if(!e)break;f(t,r,e,s)}return}}s(t,t._params,r,e);return}if(Array.isArray(r)){for([r,e]of r)f(t,r,e,s);return}"object"==typeof r&&f(t,Object.entries(r),e,s)}},c=(t,r,e)=>{"function"==typeof e&&t[r].push(e)};function l(t){if(this._params={},this._validators=this.constructor._validators.slice(),this._parsers=this.constructor._parsers.slice(),this.isAllowingUnknownParams=this.constructor.isAllowingUnknownParams,t)try{"string"==typeof t?this.add(/^magnet\:\?(.*)/.exec(t)[1]):this.add(t)}catch(r){throw Error("Invalid magnet uri.")}}Object.assign(l.prototype,{get:function(t){return t?this._params[t]:this._params},add:function(t,r){f(this,t,r,o)},remove:function(t,r){if(t){if(Array.isArray(t)&&!t.every(t=>Array.isArray(t))){for(t of t)Array.isArray(t)&&([t,r]=t),this.remove(t,r);return}if("string"==typeof t&&!/=/.test(t)&&!r){delete this._params[t];return}f(this,t,r,(t,r,e,s)=>{let i=r[e],n;i&&(s=o(t,r,e,s),(n=i.indexOf(s))>=0&&i.splice(n,1))})}},set:function(t,r){"string"==typeof t&&t&&(this.remove(t),this.add(t,r))},toString:function(){let t=(t,r)=>{try{s+=`&${t}=`+r(this._params[t][0])}catch(e){}},e=t=>t,s="",i,n,a,o;try{this._params.xt.forEach(t=>s+="&xt="+t)}catch(f){throw Error("Invalid magnet uri.")}for(i of(s="magnet:?"+s.slice(1),t("dn",encodeURIComponent),t("xl",e),t("kt",e),t("so",e),["tr","xs","as","ws"]))if(this._params[i])for(n of this._params[i])s+=`&${i}=`+encodeURIComponent(n);if(this._params["x.pe"])for(n of this._params["x.pe"])s+="&x.pe="+n;for([i,a]of o=Object.entries(this._params).filter(([t])=>!r.includes(t)))for(n of a)s+=`&${i}=`+n;return s},valueOf:function(){return this.toString()},addValidator:function(t){c(this,"_validators",t)},addParser:function(t){c(this,"_parsers",t)}}),Object.assign(l,{parseXT:e,parseSO:a,parseXPE:i,_validators:[],_parsers:[],isAllowingUnknownParams:!0,addValidator:function(t){c(this,"_validators",t)},addParser:function(t){c(this,"_parsers",t)}}),t.MagnetURI=l})(window);