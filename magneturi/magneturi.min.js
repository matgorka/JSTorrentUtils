(t=>{let r=t=>t.startsWith("urn:")?t:encodeURIComponent(t),e=[[/^xt$/,t=>t],[/^xt\.\d+$/,t=>t],[/^dn$/,encodeURIComponent],[/^xl$/,t=>t],[/^kt$/,t=>t],[/^so$/,t=>t],[/^tr$/,encodeURIComponent],[/^xs$/,r],[/^as$/,encodeURIComponent],[/^ws$/,encodeURIComponent],[/^x.pe$/,encodeURIComponent],[/^s$/,t=>t]],s=t=>/^urn:([A-Z\d]+(?::+[A-Z\d]+)*:*):(.*)/i.exec(t).slice(1),i=(t,r)=>{let e,s,i,a=7,n;if(r&&(t="http://"+t),[e,s]=/^(\w+:\/*)(.*)/.exec(t).slice(1),(i=new URL("http://"+s)).port||(i=new URL("https://"+s),a=8),["udp://","tcp://"].includes(e)&&""===i.port)throw Error();return r&&(e=""),n=e+i.href.slice(a),t.endsWith("/")||(n=n.replace(/\/$/,"")),[n,e]},a=t=>{let r,e,s,a,n,o,f,c;try{[t]=i(t,!0),o=/(.*):\d+$/.exec(t)[1]}catch(l){return}if(/^\d+(\.\d+){3}$/.test(o)){for(f of o.split("."))if(f>255)return;return t}try{if(s=/^\[([\dA-F:]+)\]$/i.exec(o)[1],[r,e,n]=s.split("::"),n||/:::/.test(s)||(a=r.split(":"),void 0!==e&&(e=e.split(":"),a=a.concat(Array(8-a.length-e.length).fill(0),e)),a.length<8))return;for(c in a)if(""==a[c]&&(a[c]=0),a[c].length>4)return}catch(p){if(!/^[A-Z\d]([A-Z\d-]*[A-Z\d])?(\.[A-Z\d]([A-Z\d-]*[A-Z\d])?)*$/i.test(o)||!/[A-Z-]/i.test(o.split(".").pop()))return}return t},n=(t,r,e,s)=>{let i,a,n,o;for(i of(s.splice(0,s.length),t.split(",")))if(i&&/^\d+(-\d+)?$/.test(i))for((a=1*(i=i.split("-"))[0])>(n=i[1]||i[0])&&([n,a]=[a,n]),o=a;o<=Math.min(n,1e6);++o)r[o]=e;for(a=-1,n=0;n<=r.length;++n)r[n]?a<0&&(a=n):a>=0&&(n-a>1&&(a+="-"+(n-1)),s.push(a),a=-1)},o=(t,r)=>{let e=[],s=[];return n(t+","+r,e,1,s),r=s.join(),n(t,e,0,s),[r,s.join()]},f=(t,r,e,n)=>{let f=r=>{let s,i;for(s of(void 0!==r&&(h=[r]),h))for(i of t._validators)if(!i(e,s))return 0;return void 0!==r&&(h=[]),1},c=[],l,p,u=[],d,h=[],$,y,g,x=1,m;try{e=e.toLowerCase(),"object"==typeof n&&(n=n.valueOf())}catch(k){return}if(["number","string"].includes(typeof n)&&""!==n){switch("kt"!=e&&(n=decodeURIComponent(n)),e){case"xl":if(parseInt(n)!=n||n<0)return;case"dn":h.push(n),x=0;break;case"s":if(/[^A-F\d]/i.test(n))return;h.push(n),x=0;break;case"kt":return r.kt||(r.kt=[""]),n=n.toLowerCase(),u=r.kt[0]+"+"+n,u=[...new Set(u.split(/[\+\s]+/))].filter(t=>""!==t).filter(t=>!r.kt[0].split("+").includes(t)).filter(t=>f(t)),n=r.kt[0].split("+").concat(u).join("+").replace(/^\+/,""),r.kt=[n],n;case"so":if(r.so||(r.so=[""]),[n,d]=o(r.so[0],n),d.length&&!f(d))return;return r.so=[n],n;case/^xt(\.\d+)?$/.test(e)?e:"":try{c=r[e].map(t=>s(t)[0])}catch(_){}try{[l,p]=s(n)}catch(A){return}if(!f([l,p]))return;if((m=c.indexOf(l))>=0)return r[e][m]=n,n;break;case/^xt\..*/.test(e)?e:"":return;case"x.pe":n=a(n),h.push(n);break;case"xs":try{if([l,p]=s(n),"btpk"!=l||!f([l,p]))return;if(r.xs&&(m=r.xs.indexOf(/^urn:/))>=0)return r.xs[m]=n,n;break}catch(v){}case"tr":case"ws":case"as":try{[n,l]=i(n)}catch(b){return}h.push([l,n]);break;default:try{$=r[e][0]}catch(w){}try{for(y of t._parsers)if(g=y(e,n,h,$))break}catch(Z){return}if(g){if("string"!=typeof g)throw TypeError("Custom parser error: string was expected");if(!Array.isArray(n=g)){x=0;break}n=n[0]}}if(n&&f())return(x||delete r[e],r[e])?(r[e].includes(n)||r[e].push(n),n):(r[e]=[n],n)}},c=(t,r,e,s)=>{if(r){if("string"==typeof r){if("string"!=typeof e){if(Array.isArray(e)){for(e of e)c(t,r,e,s);return}if(!e&&0!=e){for([r,e]of r=r.split("&").map(t=>t.split("="))){if(!e&&0!=e)break;c(t,r,e,s)}return}}s(t,t._params,r,e);return}if(Array.isArray(r)){for([r,e]of r)c(t,r,e,s);return}"object"==typeof r&&c(t,Object.entries(r),e,s)}},l=(t,r,e)=>{"function"==typeof e&&t[r].push(e)};class p{constructor(t){if(this._params={},this._validators=this.constructor._validators.slice(),this._parsers=this.constructor._parsers.slice(),!t)return;try{"string"==typeof t?this.add(/^magnet\:\?(.*)/.exec(t)[1]):this.add(t)}catch(r){throw Error("Invalid magnet uri.")}}get(t){return t?this._params[t]:this._params}add(t,r){c(this,t,r,f)}remove(t,r){if(t){if(Array.isArray(t)&&!t.every(t=>Array.isArray(t))){for(t of t)Array.isArray(t)&&([t,r]=t),this.remove(t,r);return}if("string"==typeof t&&!/=/.test(t)&&!r){delete this._params[t];return}c(this,t,r,(t,r,e,s)=>{let i=r[e],a;i&&(s=f(t,r,e,s),(a=i.indexOf(s))>=0&&i.splice(a,1))})}}set(t,r){"string"==typeof t&&t&&(this.remove(t),this.add(t,r))}toString(){let t="",r,s,i,a,n,o,f,c,l;for([f,c]of(i=(s=(r=Object.entries(this._params)).filter(([t])=>/^xt\.\d+$/.test(t)).map(([t,r])=>[t.split(".")[1],r]).sort((t,r)=>t[0]-r[0]).map(([t,r])=>["xt."+t,r])).map(([t])=>t),r=r.filter(([t])=>!i.includes(t)).concat(s),e))for(l in r)if([a,n]=r[l],f.test(a)){for(o of n)t+=`&${a}=`+c(o);r.splice(l,1)}for([a,n]of r)for(o of n)t+=`&${a}=`+o;return"magnet:?"+t.slice(1)}valueOf(){return this.toString()}toJSON(){return this.toString()}addValidator(t){l(this,"_validators",t)}addParser(t){l(this,"_parsers",t)}}Object.assign(p,{parseXT:s,parseSO:o,parseXPE:a,_validators:[],_parsers:[],addValidator:function(t){l(this,"_validators",t)},addParser:function(t){l(this,"_parsers",t)}}),t.MagnetURI=p})(window);