(t=>{let r=["xt","dn","xl","kt","so","tr","xs","as","ws","x.pe"],e=t=>/^urn:([A-Z\d]+(?::+[A-Z\d]+)*:*):(.*)/i.exec(t).slice(1),s=(t,r)=>{let e,s,i,a,o=7,n;if(r&&(t="http://"+t),[e,s]=/^(\w+:\/*)(.*)/.exec(t).slice(1),i=new URL("http://"+s),a=new URL("https://"+s),!i.port&&a.port&&(i=a,o=8),["udp://","tcp://"].includes(e)&&""===i.port)throw Error();return r&&(e=""),n=e+i.href.slice(o),t.endsWith("/")||(n=n.replace(/\/$/,"")),[n,e]},i=t=>{let r,e,i,a,o,n,f,c,p;try{[t,r]=s(t,!0),f=/(.*):\d+$/.exec(t)[1]}catch(l){return}if(/^\d+(\.\d+){3}$/.test(f)){for(c of f.split("."))if(c>255)return;return t}try{if(a=/^\[([\dA-F:]+)\]$/i.exec(f)[1],[e,i,n]=a.split("::"),n||/:::/.test(a)||(o=e.split(":"),void 0!==i&&(i=i.split(":"),o=o.concat(Array(8-o.length-i.length).fill(0),i)),o.length<8))return;for(p in o)if(""==o[p]&&(o[p]=0),o[p].length>4)return}catch(h){if(!/^[A-Z\d]([A-Z\d-]*[A-Z\d])?(\.[A-Z\d]([A-Z\d-]*[A-Z\d])?)*$/i.test(f)||!/[A-Z-]/i.test(f.split(".").pop()))return}return t},a=(t,r,e,s)=>{let i,a,o,n;for(i of(s.splice(0,s.length),t.split(",")))if(i&&/^\d+(-\d+)?$/.test(i))for((a=1*(i=i.split("-"))[0])>(o=i[1]||i[0])&&([o,a]=[a,o]),n=a;n<=Math.min(o,1e6);++n)r[n]=e;for(a=-1,o=0;o<=r.length;++o)r[o]?a<0&&(a=o):a>=0&&(o-a>1&&(a+="-"+(o-1)),s.push(a),a=-1)},o=(t,r)=>{let e=[],s=[];return a(t+","+r,e,1,s),r=s.join(),a(t,e,0,s),[r,s.join()]},n=(t,r,a,n)=>{let f=r=>{let e,s;for(e of(void 0!==r&&(u=[r]),u))for(s of t._validators)if(!s(a,e))return 0;return void 0!==r&&(u=[]),1},c=[],p,l,h=[],d,u=[],$,y,x,g=1,m;try{a=a.toLowerCase(),"object"==typeof n&&(n=n.valueOf())}catch(k){return}if(["number","string"].includes(typeof n)&&""!==n){switch("kt"!=a&&(n=decodeURIComponent(n)),a){case"xl":if(parseInt(n)!=n||n<0)return;case"dn":u.push(n),g=0;break;case"kt":return r.kt||(r.kt=[""]),n=n.toLowerCase(),h=r.kt[0]+"+"+n,h=[...new Set(h.split(/[\+\s]+/))].filter(t=>""!==t).filter(t=>!r.kt[0].split("+").includes(t)).filter(t=>f(t)),n=r.kt[0].split("+").concat(h).join("+").replace(/^\+/,""),r.kt=[n],n;case"so":if(r.so||(r.so=[""]),[n,d]=o(r.so[0],n),d.length&&!f(d))return;return r.so=[n],n;case"xt":try{c=r.xt.map(t=>e(t)[0])}catch(v){}try{[p,l]=e(n)}catch(_){return}if(!f([p,l]))return;if((m=c.indexOf(p))>=0)return r.xt[m]=n,n;break;case"x.pe":n=i(n),u.push(n);break;case"tr":case"ws":case"as":case"xs":try{[n,p]=s(n)}catch(A){return}u.push(p);break;default:try{$=r[a][0]}catch(w){}try{for(y of t._parsers)if(x=y(a,n,u,$))break}catch(b){return}if(x){if("string"!=typeof x)throw TypeError("Custom parser error: string was expected");if(!Array.isArray(n=x)){g=0;break}n=n[0]}}if(n&&f())return(g||delete r[a],r[a])?(r[a].includes(n)||r[a].push(n),n):(r[a]=[n],n)}},f=(t,r,e,s)=>{if(r){if("string"==typeof r){if("string"!=typeof e){if(Array.isArray(e)){for(e of e)f(t,r,e,s);return}if(!e&&0!=e){for([r,e]of r=r.split("&").map(t=>t.split("="))){if(!e&&0!=e)break;f(t,r,e,s)}return}}s(t,t._params,r,e);return}if(Array.isArray(r)){for([r,e]of r)f(t,r,e,s);return}"object"==typeof r&&f(t,Object.entries(r),e,s)}},c=(t,r,e)=>{"function"==typeof e&&t[r].push(e)};class p{constructor(t){if(this._params={},this._validators=this.constructor._validators.slice(),this._parsers=this.constructor._parsers.slice(),!t)return;try{"string"==typeof t?this.add(/^magnet\:\?(.*)/.exec(t)[1]):this.add(t)}catch(r){throw Error("Invalid magnet uri.")}}get(t){return t?this._params[t]:this._params}add(t,r){f(this,t,r,n)}remove(t,r){if(t){if(Array.isArray(t)&&!t.every(t=>Array.isArray(t))){for(t of t)Array.isArray(t)&&([t,r]=t),this.remove(t,r);return}if("string"==typeof t&&!/=/.test(t)&&!r){delete this._params[t];return}f(this,t,r,(t,r,e,s)=>{let i=r[e],a;i&&(s=n(t,r,e,s),(a=i.indexOf(s))>=0&&i.splice(a,1))})}}set(t,r){"string"==typeof t&&t&&(this.remove(t),this.add(t,r))}toString(){let t=(t,r)=>{try{s+=`&${t}=`+r(this._params[t][0])}catch(e){}},e=t=>t,s="",i,a,o,n;try{this._params.xt.forEach(t=>s+="&xt="+t)}catch(f){throw Error("Invalid magnet uri.")}for(i of(s="magnet:?"+s.slice(1),t("dn",encodeURIComponent),t("xl",e),t("kt",e),t("so",e),["tr","xs","as","ws"]))if(this._params[i])for(a of this._params[i])s+=`&${i}=`+encodeURIComponent(a);if(this._params["x.pe"])for(a of this._params["x.pe"])s+="&x.pe="+a;for([i,o]of n=Object.entries(this._params).filter(([t])=>!r.includes(t)))for(a of o)s+=`&${i}=`+a;return s}valueOf(){return this.toString()}addValidator(t){c(this,"_validators",t)}addParser(t){c(this,"_parsers",t)}}Object.assign(p,{parseXT:e,parseSO:o,parseXPE:i,_validators:[],_parsers:[],addValidator:function(t){c(this,"_validators",t)},addParser:function(t){c(this,"_parsers",t)}}),t.MagnetURI=p})(window);